services:
  postgres:
    image: postgres:17-alpine
    container_name: passdesk_postgres
    environment:
      POSTGRES_DB: passdesk
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Set_DB_PASSWORD_in_.env}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./dbsu10_schema.sql:/docker-entrypoint-initdb.d/001_schema.sql:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d passdesk"]
      interval: 5s
      timeout: 5s
      retries: 20

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: passdesk_server
    environment:
      NODE_ENV: production
      PORT: 5000
      API_VERSION: ${API_VERSION:-v1}
      CLIENT_URL: ${CLIENT_URL:?Set_CLIENT_URL_in_.env}
      SERVER_URL: ${SERVER_URL:-}

      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: passdesk
      DB_USER: admin
      DB_PASSWORD: ${DB_PASSWORD:?Set_DB_PASSWORD_in_.env}
      DB_SSL: ${DB_SSL:-false}

      JWT_SECRET: ${JWT_SECRET:?Set_JWT_SECRET_in_.env}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?Set_JWT_REFRESH_SECRET_in_.env}
      JWT_EXPIRE: ${JWT_EXPIRE:-2h}
      JWT_REFRESH_EXPIRE: ${JWT_REFRESH_EXPIRE:-7d}
      BCRYPT_ROUNDS: ${BCRYPT_ROUNDS:-10}

      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-cloudru}
      CLOUDRU_S3_ENDPOINT: ${CLOUDRU_S3_ENDPOINT:-https://s3.ru1.storage.beget.cloud}
      CLOUDRU_S3_REGION: ${CLOUDRU_S3_REGION:-ru1}
      CLOUDRU_S3_ACCESS_KEY_ID: ${CLOUDRU_S3_ACCESS_KEY_ID:?Set_CLOUDRU_S3_ACCESS_KEY_ID_in_.env}
      CLOUDRU_S3_SECRET_ACCESS_KEY: ${CLOUDRU_S3_SECRET_ACCESS_KEY:?Set_CLOUDRU_S3_SECRET_ACCESS_KEY_in_.env}
      CLOUDRU_S3_BUCKET_NAME: ${CLOUDRU_S3_BUCKET_NAME:?Set_CLOUDRU_S3_BUCKET_NAME_in_.env}
      CLOUDRU_S3_BASE_PATH: ${CLOUDRU_S3_BASE_PATH:-}
      CLOUDRU_S3_KMS_KEY_ID: ${CLOUDRU_S3_KMS_KEY_ID:-}

      FIELD_ENCRYPTION_ENABLED: ${FIELD_ENCRYPTION_ENABLED:-true}
      APP_FIELD_ENCRYPTION_ACTIVE_KEY_VERSION: ${APP_FIELD_ENCRYPTION_ACTIVE_KEY_VERSION:-v1}
      APP_FIELD_ENCRYPTION_KEYS: ${APP_FIELD_ENCRYPTION_KEYS:?Set_APP_FIELD_ENCRYPTION_KEYS_in_.env}
      APP_FIELD_HASH_PEPPER: ${APP_FIELD_HASH_PEPPER:?Set_APP_FIELD_HASH_PEPPER_in_.env}
      # Keep true until app code no longer reads legacy plaintext doc columns.
      FIELD_ENCRYPTION_KEEP_LEGACY_DOC_PLAINTEXT: ${FIELD_ENCRYPTION_KEEP_LEGACY_DOC_PLAINTEXT:-true}

      FILE_ENCRYPTION_ENABLED: ${FILE_ENCRYPTION_ENABLED:-true}
      FILE_ENCRYPTION_SENSITIVE_DOC_TYPES: ${FILE_ENCRYPTION_SENSITIVE_DOC_TYPES:-passport,kig,patent_front,patent_back,application_scan}
      FILE_PROXY_TOKEN_TTL_SECONDS: ${FILE_PROXY_TOKEN_TTL_SECONDS:-300}

      OCR_ENABLED: ${OCR_ENABLED:-true}
      OCR_PROVIDER: ${OCR_PROVIDER:-openrouter}
      OCR_API_KEY: ${OCR_API_KEY:?Set_OCR_API_KEY_in_.env}
      OCR_OPENROUTER_ENDPOINT: ${OCR_OPENROUTER_ENDPOINT:-https://openrouter.ai/api/v1/chat/completions}
      OCR_OPENROUTER_MODEL: ${OCR_OPENROUTER_MODEL:-qwen/qwen3-vl-30b-a3b-instruct}
      OCR_OPENROUTER_HTTP_REFERER: ${OCR_OPENROUTER_HTTP_REFERER:-}
      OCR_OPENROUTER_APP_TITLE: "${OCR_OPENROUTER_APP_TITLE:-PassDesk OCR}"
      OCR_REQUEST_TIMEOUT_MS: ${OCR_REQUEST_TIMEOUT_MS:-60000}
      OCR_MAX_FILE_SIZE: ${OCR_MAX_FILE_SIZE:-10485760}
      OCR_PASSPORT_RF_PROMPT: ${OCR_PASSPORT_RF_PROMPT:-}
      OCR_FOREIGN_PASSPORT_PROMPT: ${OCR_FOREIGN_PASSPORT_PROMPT:-}
      OCR_PATENT_PROMPT: ${OCR_PATENT_PROMPT:-}
      OCR_VISA_PROMPT: ${OCR_VISA_PROMPT:-}
      OCR_KIG_PROMPT: ${OCR_KIG_PROMPT:-}

      MVD_API_TOKEN: ${MVD_API_TOKEN:?Set_MVD_API_TOKEN_in_.env}
      MVD_API_URL: ${MVD_API_URL:-https://api-cloud.ru/api/mvd.php}
      MVD_API_TIMEOUT_MS: ${MVD_API_TIMEOUT_MS:-120000}

    command: >
      sh -c "npm ci --omit=dev && npm run db:migrate && npm run start"
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "5003:5000"
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - "wget -qO- http://127.0.0.1:5000/health >/dev/null 2>&1 || exit 1"
      interval: 20s
      timeout: 5s
      retries: 10

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    environment:
      VITE_DEV_HTTPS: "false"
      VITE_ALLOWED_HOSTS: pd.devdenis.ru,localhost,127.0.0.1
    container_name: passdesk_client
    command: >
      sh -c "npm ci && npm run build && npm run preview -- --host 0.0.0.0 --port 5173"
    depends_on:
      server:
        condition: service_healthy
    ports:
      - "5173:5173"
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - "wget -qO- http://127.0.0.1:5173 >/dev/null 2>&1 || exit 1"
      interval: 20s
      timeout: 5s
      retries: 10

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: passdesk_pgadmin
    profiles: ["ops"]
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
    ports:
      - "5050:80"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:

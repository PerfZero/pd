import { useMemo } from "react";

const buildAvailableColumns = ({
  showDepartmentColumn,
  showCounterpartyColumn,
}) => [
  { key: "index", label: "№" },
  { key: "fullName", label: "ФИО" },
  { key: "position", label: "Должность" },
  ...(showDepartmentColumn ? [{ key: "department", label: "Подразделение" }] : []),
  ...(showCounterpartyColumn ? [{ key: "counterparty", label: "Контрагент" }] : []),
  { key: "constructionSite", label: "Объект" },
  { key: "citizenship", label: "Гражданство" },
  { key: "statusCard", label: "Заполнен" },
  { key: "createdAt", label: "Дата создания" },
  { key: "files", label: "Файлы" },
  { key: "documentExpiry", label: "Срок действия док." },
  { key: "status", label: "Статус" },
  { key: "actions", label: "Действия" },
];

const useEmployeesPageViewModels = ({
  backgroundLoading,
  employees,
  totalCount,
  canExport,
  searchText,
  statusFilter,
  setSearchText,
  setStatusFilter,
  handleResetFilters,
  showDepartmentColumn,
  showCounterpartyColumn,
  hiddenColumns,
  handleToggleColumn,
  handleResetColumns,
  handleAdd,
  handleRequest,
  setIsImportModalOpen,
  setIsSecurityModalOpen,
  filteredEmployees,
  loading,
  departments,
  uniqueFilters,
  defaultCounterpartyId,
  user,
  resetTrigger,
  canDeleteEmployee,
  canMarkForDeletion,
  handleView,
  handleEdit,
  handleDelete,
  handleViewFiles,
  handleMarkForDeletion,
  handleDepartmentChange,
  setTableFilters,
  handleConstructionSitesEdit,
  isModalOpen,
  editingEmployee,
  isViewModalOpen,
  viewingEmployee,
  isFilesModalOpen,
  filesEmployee,
  isSitesModalOpen,
  sitesEmployee,
  isRequestModalOpen,
  tableFilters,
  isExportModalOpen,
  isImportModalOpen,
  isSecurityModalOpen,
  setIsModalOpen,
  setEditingEmployee,
  handleFormSuccess,
  handleCheckInn,
  setIsViewModalOpen,
  setViewingEmployee,
  handleMobileViewEdit,
  closeFilesModal,
  handleFilesUpdated,
  closeSitesModal,
  handleSitesUpdated,
  setIsRequestModalOpen,
  refetchEmployees,
  setIsExportModalOpen,
}) => {
  const availableColumns = useMemo(
    () =>
      buildAvailableColumns({
        showDepartmentColumn,
        showCounterpartyColumn,
      }),
    [showCounterpartyColumn, showDepartmentColumn],
  );

  const toolbarView = useMemo(
    () => ({
      backgroundLoading,
      loadedEmployeesCount: employees.length,
      totalCount,
      canExport,
    }),
    [backgroundLoading, employees.length, totalCount, canExport],
  );

  const toolbarFilters = useMemo(
    () => ({
      searchText,
      statusFilter,
      onSearchTextChange: setSearchText,
      onStatusFilterChange: setStatusFilter,
      onResetFilters: handleResetFilters,
    }),
    [
      searchText,
      statusFilter,
      setSearchText,
      setStatusFilter,
      handleResetFilters,
    ],
  );

  const toolbarColumns = useMemo(
    () => ({
      availableColumns,
      hiddenColumns,
      onToggleColumn: handleToggleColumn,
      onResetColumns: handleResetColumns,
    }),
    [availableColumns, hiddenColumns, handleToggleColumn, handleResetColumns],
  );

  const toolbarActions = useMemo(
    () => ({
      onAdd: handleAdd,
      onRequest: handleRequest,
      onImport: () => setIsImportModalOpen(true),
      onSecurity: () => setIsSecurityModalOpen(true),
    }),
    [handleAdd, handleRequest, setIsImportModalOpen, setIsSecurityModalOpen],
  );

  const employeesListModel = useMemo(
    () => ({
      filteredEmployees,
      loading,
      departments,
      canExport,
      showCounterpartyColumn,
      uniqueFilters,
      defaultCounterpartyId,
      userCounterpartyId: user?.counterpartyId,
      resetTrigger,
      hiddenColumns,
      canDeleteEmployee,
      canMarkForDeletion,
    }),
    [
      filteredEmployees,
      loading,
      departments,
      canExport,
      showCounterpartyColumn,
      uniqueFilters,
      defaultCounterpartyId,
      user?.counterpartyId,
      resetTrigger,
      hiddenColumns,
      canDeleteEmployee,
      canMarkForDeletion,
    ],
  );

  const employeesListActions = useMemo(
    () => ({
      onView: handleView,
      onEdit: handleEdit,
      onDelete: handleDelete,
      onViewFiles: handleViewFiles,
      onMarkForDeletion: handleMarkForDeletion,
      onDepartmentChange: handleDepartmentChange,
      onFiltersChange: setTableFilters,
      onConstructionSitesEdit: handleConstructionSitesEdit,
    }),
    [
      handleView,
      handleEdit,
      handleDelete,
      handleViewFiles,
      handleMarkForDeletion,
      handleDepartmentChange,
      setTableFilters,
      handleConstructionSitesEdit,
    ],
  );

  const employeesModalModel = useMemo(
    () => ({
      isModalOpen,
      editingEmployee,
      isViewModalOpen,
      viewingEmployee,
      isFilesModalOpen,
      filesEmployee,
      isSitesModalOpen,
      sitesEmployee,
      isRequestModalOpen,
      filteredEmployees,
      tableFilters,
      userRole: user?.role,
      userCounterpartyId: user?.counterpartyId,
      defaultCounterpartyId,
      userId: user?.id,
      isExportModalOpen,
      isImportModalOpen,
      isSecurityModalOpen,
    }),
    [
      isModalOpen,
      editingEmployee,
      isViewModalOpen,
      viewingEmployee,
      isFilesModalOpen,
      filesEmployee,
      isSitesModalOpen,
      sitesEmployee,
      isRequestModalOpen,
      filteredEmployees,
      tableFilters,
      user?.role,
      user?.counterpartyId,
      defaultCounterpartyId,
      user?.id,
      isExportModalOpen,
      isImportModalOpen,
      isSecurityModalOpen,
    ],
  );

  const employeesModalActions = useMemo(
    () => ({
      setIsModalOpen,
      setEditingEmployee,
      onFormSuccess: handleFormSuccess,
      onCheckInn: handleCheckInn,
      setIsViewModalOpen,
      setViewingEmployee,
      onMobileViewEdit: handleMobileViewEdit,
      onCloseFilesModal: closeFilesModal,
      onFilesUpdated: handleFilesUpdated,
      onCloseSitesModal: closeSitesModal,
      onSitesUpdated: handleSitesUpdated,
      setIsRequestModalOpen,
      refetchEmployees,
      setIsExportModalOpen,
      setIsImportModalOpen,
      setIsSecurityModalOpen,
    }),
    [
      setIsModalOpen,
      setEditingEmployee,
      handleFormSuccess,
      handleCheckInn,
      setIsViewModalOpen,
      setViewingEmployee,
      handleMobileViewEdit,
      closeFilesModal,
      handleFilesUpdated,
      closeSitesModal,
      handleSitesUpdated,
      setIsRequestModalOpen,
      refetchEmployees,
      setIsExportModalOpen,
      setIsImportModalOpen,
      setIsSecurityModalOpen,
    ],
  );

  return {
    toolbarView,
    toolbarFilters,
    toolbarColumns,
    toolbarActions,
    employeesListModel,
    employeesListActions,
    employeesModalModel,
    employeesModalActions,
  };
};

export default useEmployeesPageViewModels;

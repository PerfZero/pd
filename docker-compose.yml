services:
  # PostgreSQL для локальной разработки
  postgres:
    image: postgres:17-alpine
    container_name: passdesk_postgres
    environment:
      POSTGRES_DB: passdesk
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./dbsu10_schema.sql:/docker-entrypoint-initdb.d/001_schema.sql:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d passdesk"]
      interval: 5s
      timeout: 5s
      retries: 10

  # pgAdmin для управления БД (опционально)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: passdesk_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  server_sync:
    image: alpine:3.20
    container_name: passdesk_server_sync
    command: >
      sh -c "apk add --no-cache rsync >/dev/null &&
      while true; do
      rsync -a --delete --exclude node_modules /source/ /target/ || true;
      sleep 1;
      done"
    volumes:
      - ./server:/source:ro,cached
      - server_src:/target
    restart: unless-stopped

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: passdesk_server
    environment:
      NODE_ENV: development
      PORT: 5000
      API_VERSION: v1
      CLIENT_URL: http://pd.devdenis.ru
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: passdesk
      DB_USER: admin
      DB_PASSWORD: ${DB_PASSWORD:-change_me_local_db_password}
      DB_SSL: "false"
      JWT_SECRET: ${JWT_SECRET:-change_me_change_me_change_me_32chars}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-change_me_change_me_change_me_other_32chars}
      STORAGE_PROVIDER: cloudru
      CLOUDRU_S3_ENDPOINT: https://s3.ru1.storage.beget.cloud
      CLOUDRU_S3_REGION: ru1
      CLOUDRU_S3_ACCESS_KEY_ID: ${CLOUDRU_S3_ACCESS_KEY_ID:-}
      CLOUDRU_S3_SECRET_ACCESS_KEY: ${CLOUDRU_S3_SECRET_ACCESS_KEY:-}
      CLOUDRU_S3_BUCKET_NAME: ${CLOUDRU_S3_BUCKET_NAME:-}
      CLOUDRU_S3_BASE_PATH: ""
      FIELD_ENCRYPTION_ENABLED: true
      APP_FIELD_ENCRYPTION_ACTIVE_KEY_VERSION: v1
      APP_FIELD_ENCRYPTION_KEYS: ${APP_FIELD_ENCRYPTION_KEYS:-}
      APP_FIELD_HASH_PEPPER: ${APP_FIELD_HASH_PEPPER:-}
      FIELD_ENCRYPTION_KEEP_LEGACY_DOC_PLAINTEXT: "false"
      FILE_ENCRYPTION_ENABLED: true
      FILE_ENCRYPTION_SENSITIVE_DOC_TYPES: passport,kig,patent_front,patent_back,application_scan
      FILE_PROXY_TOKEN_TTL_SECONDS: 300
      OCR_ENABLED: true
      OCR_PROVIDER: openrouter
      OCR_API_KEY: ${OCR_API_KEY:-}
      OCR_OPENROUTER_ENDPOINT: ${OCR_OPENROUTER_ENDPOINT:-https://openrouter.ai/api/v1/chat/completions}
      OCR_OPENROUTER_MODEL: ${OCR_OPENROUTER_MODEL:-qwen/qwen3-vl-30b-a3b-instruct}
      OCR_OPENROUTER_HTTP_REFERER: ${OCR_OPENROUTER_HTTP_REFERER:-}
      OCR_OPENROUTER_APP_TITLE: ${OCR_OPENROUTER_APP_TITLE:-PassDesk OCR}
      OCR_REQUEST_TIMEOUT_MS: ${OCR_REQUEST_TIMEOUT_MS:-60000}
      OCR_MAX_FILE_SIZE: ${OCR_MAX_FILE_SIZE:-10485760}
      OCR_PASSPORT_RF_PROMPT: ${OCR_PASSPORT_RF_PROMPT:-}
      MVD_API_TOKEN: ${MVD_API_TOKEN:-}
      MVD_API_URL: ${MVD_API_URL:-https://api-cloud.ru/api/mvd.php}
      MVD_API_TIMEOUT_MS: ${MVD_API_TIMEOUT_MS:-120000}
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "5003:5000"
    command: >
      sh -c "until [ -f package.json ]; do echo 'Waiting for synced server sources...'; sleep 1; done;
      if [ ! -d node_modules ] || [ -z \"$(ls -A node_modules 2>/dev/null)\" ];
      then npm ci; fi;
      npm run db:migrate && npm run dev"
    depends_on:
      postgres:
        condition: service_healthy
      server_sync:
        condition: service_started
    volumes:
      - server_src:/app
      - server_node_modules:/app/node_modules
    restart: unless-stopped

  client_sync:
    image: alpine:3.20
    container_name: passdesk_client_sync
    command: >
      sh -c "apk add --no-cache rsync >/dev/null &&
      while true; do
      rsync -a --delete --exclude node_modules --exclude dist /source/ /target/ || true;
      sleep 1;
      done"
    volumes:
      - ./client:/source:ro,cached
      - client_src:/target
    restart: unless-stopped

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: passdesk_client
    environment:
      VITE_DEV_HOST: 0.0.0.0
      VITE_DEV_PORT: 5173
      VITE_DEV_HTTPS: "false"
      VITE_ALLOWED_HOSTS: pd.devdenis.ru,localhost,127.0.0.1
      VITE_PROXY_TARGET: http://server:5000
      VITE_USE_POLLING: "true"
      VITE_POLLING_INTERVAL: "150"
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "150"
      WATCHPACK_POLLING: "true"
    ports:
      - "5173:5173"
    command: >
      sh -c "until [ -f package.json ]; do echo 'Waiting for synced client sources...'; sleep 1; done;
      if [ ! -d node_modules ] || [ -z \"$(ls -A node_modules 2>/dev/null)\" ];
      then npm ci; fi;
      npm run dev -- --host 0.0.0.0 --port 5173"
    depends_on:
      - server
      - client_sync
    volumes:
      - client_src:/app
      - client_node_modules:/app/node_modules
    restart: unless-stopped

volumes:
  postgres_data:
  server_src:
  server_node_modules:
  client_src:
  client_node_modules:
